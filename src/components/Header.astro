---
// Header.astro

import NavItem from "./NavItem.tsx";

interface Props {
	currentPath?: string;
	centerText?: string;
}

const { currentPath = "/", centerText = "" } = Astro.props;

const navItems = [
	{ label: "Blog", windowName: "blog" },
	{ label: "About", windowName: "about" },
	{ label: "Contact", windowName: "contact" },
];

---

<script is:inline>
    import {createWindow} from "../lib/windowManager.ts";
    import {defaultWindowConfigs} from "../lib/windowConfigs.ts";

    const CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const activeAnimations = new WeakMap();

    function getRandomChar() {
        return CHARS[Math.floor(Math.random() * CHARS.length)];
    }

    function shuffleText(element) {
        // Cancel any existing animation on this element
        if (activeAnimations.has(element)) {
            clearInterval(activeAnimations.get(element));
        }

        const originalText = element.dataset.originalText || element.textContent;
        element.dataset.originalText = originalText;

        const textLength = originalText.length;
        const duration = 600;
        const frameRate = 50;
        const totalFrames = Math.ceil(duration / frameRate);
        let currentFrame = 0;

        const interval = setInterval(() => {
            let displayText = '';
            const progress = currentFrame / totalFrames;
            const revealCount = Math.floor(textLength * progress);

            for (let i = 0; i < textLength; i++) {
                if (i < revealCount) {
                    displayText += originalText[i];
                } else {
                    displayText += getRandomChar();
                }
            }

            element.textContent = displayText;
            currentFrame++;

            if (currentFrame > totalFrames) {
                clearInterval(interval);
                activeAnimations.delete(element);
                element.textContent = originalText;
            }
        }, frameRate);

        activeAnimations.set(element, interval);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Find the header and only target leaf elements that contain text
        const header = document.querySelector('.site-header');
        if (!header) return;

        const targets = Array.from(header.querySelectorAll('*')).filter(el => {
            if (el.children.length > 0) return false;
            const txt = (el.textContent || '').trim();
            return txt.length > 0;
        });

        targets.forEach(el => shuffleText(el));
    });
</script>

<header class="site-header">
    <div class="header-container">
        <div class="header-name">
            <div class="name">
                genr234
            </div>
        </div>

        <span class="header-center">
            {centerText}
        </span>

        <nav class="header-nav">
            {navItems.map(item => (
                    <NavItem
                            label={item.label}
                            windowName={item.windowName}
                            client:load
                    />
            ))}
        </nav>
    </div>
</header>

<style lang="scss">
    .site-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: transparent;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .header-container {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 12px 20px;
        max-width: 100%;
        font-family: Gentle, sans-serif;
        background: transparent;
    }

    .header-name {
        justify-self: start;
        mix-blend-mode: normal;
    }

    .name {
        text-decoration: none;
        font-family: Nano, sans-serif;
        font-size: 1.125rem;
        font-weight: 400;
        display: inline-block;
        letter-spacing: 0.01em;
        color: #ffffff;
        mix-blend-mode: difference;
        -webkit-text-fill-color: currentColor;
        position: relative;
        z-index: auto;
    }

    .header-center,
    .header-nav {
        mix-blend-mode: normal;
    }

    .header-nav {
        /* keep nav container layout scoped */
        justify-self: end;
        display: flex;
        gap: 2rem;
        position: relative;
        z-index: 1010; /* sit above background canvas but below cursor (9999) */
    }

    .header-nav :global(*) {
        mix-blend-mode: normal !important;
    }

    .header-nav > * {
        mix-blend-mode: normal !important;
       color: #0d0d0d !important;
       opacity: 0.9 !important;
      position: relative;
    }


    @media (max-width: 768px) {
        .header-container {
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
        }

        .header-name,
        .header-center,
        .header-nav {
            justify-self: center;
        }

        .header-nav {
            gap: 1.5rem;
        }
    }
</style>